{% extends 'base.html' %}

{% block title %}Заказ №{{ order.id }} {% endblock title %}


{% block content %}
    <div class="container mt-3">
        {% for staff in order.order_cliners.all %}
            {% if staff.staff == user %}
                {% if not staff.in_place %}
                    <a href="{% url 'crmapp:cleaner_in_place' order.id %}" class="btn btn-dark">На месте</a>
                {% elif staff.in_place and not staff.work_start %}
                    <a href="{% url 'crmapp:cleaner_work_start' order.id %}" class="btn btn-success">Начать работу</a>
                    {% if user == brigadir.staff %}
                        <a href="{% url 'crmapp:foremanorder_create' order.id %}" class="btn btn-warning">Внести изменения в заказ</a>
                            <form class="mt-3" action="{% url 'crmapp:foreman_photo_before' order.id %}" method="POST" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input class="btn btn-secondary" type="file" name="photo_before" multiple>
                                <button type="submit" class="btn btn-primary">Отправить фото до</button>
                            </form>
                    {% endif %}
                {% elif staff.in_place and staff.work_start %}
                    {% if user == brigadir.staff %}
                        <a href="{% url 'crmapp:cleaner_work_end' order.id %}" class="btn btn-info">Добавить услугу в заказ</a>
                        <a href="{% url 'crmapp:cleaner_work_end' order.id %}" class="btn btn-danger">Закончить работу</a>
                        <form class="mt-3" action="{% url 'crmapp:foreman_photo_before' order.id %}" method="POST" enctype="multipart/form-data">
                            {% csrf_token %}
                            <input class="btn btn-secondary" type="file" name="photo_after" multiple>
                            <button type="submit" class="btn btn-primary">Отправить фото после</button>
                        </form>
                    {% endif %}
                {% endif %}
            {% endif %}
        {% endfor %}

        <p><strong>Заказ № {{ order.id }} Cтатус: {{ order.get_status_display }}</strong></p>
        <p><strong>Дата и время:</strong> {{ order.work_start }}</p>
        <p><strong>Адресс:</strong> {{ order.address | capfirst }}</p>
        <p><strong>Тип объекта:</strong> {{ order.object_type | capfirst }}</p>
        {% if extra_service %}
            <p><strong>Услуги Заказа:</strong></p>
            {% for extra in extra_service %}
                <ul>
                    <li>
                        <p {% if foreman_update %} class="text-muted" {% endif %}>{{ extra | capfirst }}
                            <a href="{% url 'crmapp:service_order_update' extra.id %}"><i
                                    class="fa-solid fa-pen-to-square"></i></a>
                            <a class="text-danger" href="{% url 'crmapp:service_order_delete' extra.id %}"><i
                                    class="fa-solid fa-xmark"></i></a>
                        </p>
                    </li>
                </ul>
            {% endfor %}
        {% endif %}
        <p><a class="btn btn-primary" href="{% url 'crmapp:service_order_create' order.id %}">+Добавить
            услугу</a></p>

        {% if foreman_update %}
            <p><strong>Обновлённые услуги заказа:</strong></p>
                <ol>
                    {% for service in foreman_update.services.all %}
                        <li>{{ service | capfirst }}</li>
                    {% endfor %}
                </ol>
        {% endif %}

        <p><strong>Общее время работы:</strong> {{ order.cleaning_time }} ч.</p>
        <span><strong>Клинеры на объекте:</strong></span>
        {% for cleaner in staff %}
            <ul>
                <li>
                    <a style="text-decoration: none"
                       href="{% url 'accounts:profile' cleaner.id %}"> {{ cleaner.staff.first_name }} {{ cleaner.staff.last_name }} </a>
                    <a class="text-danger" href="{% url 'crmapp:order_staff_delete' cleaner.id %}"><i
                            class="fa-solid fa-xmark"></i></a>
                </li>
            </ul>
        {% endfor %}
        <p><a class="btn btn-primary" href="{% url 'crmapp:order_staff_add' order.id %}">+Добавить
            клинера</a></p>
        <p><strong>Вид оплаты: </strong>{{ order.get_payment_type_display }}</p>
        <h5><strong>Общая стоимость: {{ order.get_total }} с </strong></h5>
        <hr>
        <p>Менеджер: {{ order.manager.first_name }} {{ order.manager.last_name }}</p>
        <small class="text-muted">Заказ создан: {{ order.created_at }}</small>
        <p><a class="btn btn-outline-primary" href="{% url 'crmapp:foreman_photo' order.id %}">Просмотреть фотографии</a></p>
       <p><a class="btn btn-dark" href="{% url 'crmapp:manager_report_create' order.id %}">Рассчитать ЗП</a></p>
    </div>
{% endblock content %}